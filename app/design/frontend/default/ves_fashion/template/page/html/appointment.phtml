<?php 
$mageFilename = 'app/Mage.php';
require_once $mageFilename;

//Set session
Mage::getSingleton('core/session')->setReturnPath("agenda-una-cita");

Mage::app('default');
if($_POST){
	//Información cita:
	$sede = $_POST['location'];
	$fecha = $_POST['days'];
	$hora = $_POST['hours'];

	$id = $_POST['id'];
	$email = $_POST['email'];
	$name = $_POST['name'];
	$phone = $_POST['phone'];
	$nota = $_POST['notes'];

	$resource = Mage::getSingleton('core/resource');
    $readConnection = $resource->getConnection('core_read');

    $sedequery = "SELECT name FROM ziente_locations WHERE id = $sede LIMIT 1";
    $sede_name = $readConnection->fetchOne($sedequery);

    $fecha_query = "SELECT date FROM ziente_days WHERE id = '$fecha' and location_id = '$sede' LIMIT 1 ";
    $fecha_date = $readConnection->fetchOne($fecha_query);

    $hora_query = "SELECT time FROM ziente_hours WHERE id = '$hora' and day_id = '$fecha' LIMIT 1 ";
    $hora_date = $readConnection->fetchOne($hora_query); 
    
    $email_query = "SELECT email FROM ziente_locations WHERE id = $sede LIMIT 1";
    $email_sede = $readConnection->fetchOne($email_query);


    $address_query = "SELECT address FROM ziente_locations WHERE id = $sede LIMIT 1";
    $address_sede = $readConnection->fetchOne($address_query);

    $phone_query = "SELECT phone FROM ziente_locations WHERE id = $sede LIMIT 1";
    $phone_sede = $readConnection->fetchOne($phone_query);


    $writeConnection = $resource->getConnection('core_write');
    $query = "UPDATE ziente_hours 
    			SET customer_id = $id, name = '$name', email= '$email', phone = '$phone', notes = '$nota', reservation_date = '$fecha_date' 
    			WHERE day_id = $fecha and id = $hora";
    $writeConnection->query($query);

	$email_subject = 'Ziente: Citas';
	$email_message = "Se agendó la siguiente cita:\n\n";
	$email_message .= "Nombre: ".utf8_decode($name)."\n";
	$email_message .= "E-mail: ". $email. "\n";
	$email_message .= "Teléfono: ". $phone. "\n";
	$email_message .= "Nota: " .nl2br(utf8_decode($nota)). "\n";
	$email_message .= "Sede: " .nl2br(utf8_decode($sede_name)). "\n";
	$email_message .= "Fecha: " .utf8_decode($fecha_date). "\n";
	$email_message .= "Hora: " .utf8_decode($hora_date). "\n";

	$ident_general = Mage::getStoreConfig('trans_email/ident_support/email');
	$headers = 'From: '.$email."\r\n".
	'Reply-To: '.$email."\r\n" .
	'X-Mailer: PHP/' . phpversion();

	@mail($email_sede, $email_subject, $email_message, $headers);
	$sucess = true;

	//Send email to customer
	sendNotification($name, $email, $sede_name, $address_sede, $phone_sede, $fecha_date, $hora_date);
}

	function sendNotification($toName, $toEmail, $location, $address, $phone, $date, $time) {
		$storeId = Mage::app ()->getStore ()->getId ();
		$templateId = '9';
		$mailSubject = $title;
		$fromName = "Admin";
		$fromEmail = "admin@ziente.co";
		
		$sender = array (
				'name' => $fromName,
				'email' => $fromEmail 
		);
		
		$vars = Array (
				'name' => $toName,
				'location' => $location,
				'address' => $address,
				'phone' => $phone,
				'date' => $date,
				'time' => $time
		);
		
		$mailTemplate = Mage::getModel ( 'core/email_template' );
		$mailTemplate->setTemplateSubject ( $mailSubject )->sendTransactional ( $templateId, $sender, $toEmail, $toName, $vars, $storeId );
		
		return true;
	}
?>


<div id="appointment">
	<h1><span>Agenda una cita</span></h1>

	<?php 
	if($_POST){
			if($sucess == true){
				echo '<ul class="messages" style="margin-top:30px !important;"><li class="success-msg" style="margin:0;"><ul><li style="margin:0">Tu cita fue agendada con &eacute;xito!</li></ul></li></ul>';
			}
		}
	?>

	<div class="form">

	<?php 
		//Get the customer data
		$customerId = Mage::getSingleton('customer/session')->getCustomer()->getId();
		$customerName = Mage::getSingleton('customer/session')->getCustomer()->getName();
		$customerEmail = Mage::getSingleton('customer/session')->getCustomer()->getEmail();
		
		if($customerId == ''){
	?>

		<div id="appointment-intro">
			<h2>PRUÉBATE UNA CAMISA ZIENTE</h2>
			<p>¿Quieres probarte una camisa ZIENTE antes de comprarla? Programa una cita y pasa por nuestro showroom. Podrás conocer todos nuestros productos.</p>

			<div class="button-center"><button class="button7" onclick="location.href='customer/account/'">AGENDA UNA CITA</button></div>
		</div>

	<?php
		}else{
	?>

		<div class="form-confirmation">
			<form action="<?php echo $this->getPostActionUrl() ?>" method="post" id="confirmation-form">
				<div class="options">
					<p>Seleccione las siguientes opciones:</p>

					<?php $collection1 = Mage::getModel('appointments/locations')->getCollection()->addFilter('active', 1);?>

					<p>Sede
					    <select name="location" id="locations" class="locations">
							<option value=" " selected="selected">Selecciona</option>
							<?php foreach($collection1 as $location) { ?>
					        	<option value="<?php echo $location->getId();?>"><?php echo $location->getName() . ' - ' . $location->getAddress();?></option>
					        <?php } ?>
					    </select>
					</p>

					<p>Fecha
						<select name="days" id="days" class="days">
							<option value=" " selected="selected">Selecciona</option>
						</select>
					</p>

				    <p>Hora
						<select name="hours" id="hours" class="hours">
							<option value=" " selected="selected">Selecciona</option>
						</select>
					</p>
				</div>

				<div class="confirmation">
					<p>Confirmación</p>			
					<div class="">
						<p>Nombre: <?php echo $customerName; ?></p>
						<p>Email:  <?php echo $customerEmail; ?></p>
						<p>Teléfono: <input type="text" name="phone" id="phone" /></p>
						<p>Notas adicionales <textarea name="notes"></textarea></p>
					</div>
				</div>

				<div class="form-buttons">
					<input type="hidden" id="id" name="id" value="<?php echo $customerId; ?>">
					<input type="hidden" id="name" name="name" value="<?php echo $customerName; ?>">
					<input type="hidden" id="email" name="email" value="<?php echo $customerEmail; ?>">
					<button class="button" id="confirm-button" onclick="return confirm()">Confirmar</button>
				</div>
			</form>
		</div>

	<?php
		}
	?>

	</div>
</div>


<script type="text/javascript">
	function confirm(){
   		var location = jQuery("#locations").val();
   		var day = jQuery("#days").val();
   		var hour = jQuery("#hours").val();

		if(location == ' '){
			alert("Por favor seleccione una sede");
			return false;
		}
		if(day == ' '){
			alert("Por favor seleccione un dia");
			return false;
		}
		if(hour == ' '){
			alert("Por favor seleccione una hora");
			return false;
		}

		return true;
	}	

	jQuery(document).ready(function (){
		jQuery('.locations').change(function() {
			var idLocation = jQuery("#locations").val();

			jQuery.ajax({
				url: '<?php echo Mage::getBaseUrl();?>ajax/days.php?id='+idLocation,
				context: document.body,
				success: function(data) {
					jQuery('#days').html(data);
				}
		  	});
		});

		jQuery('.days').change(function() {
			var idDay = jQuery("#days").val();

			jQuery.ajax({
				url: '<?php echo Mage::getBaseUrl();?>ajax/hours.php?id='+idDay,
				context: document.body,
				success: function(data) {
					jQuery('#hours').html(data);
				}
		  	});
		});
    });
</script>